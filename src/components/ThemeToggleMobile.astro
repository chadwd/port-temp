---
// Mobile-only floating action button for theme toggle
---

<button type="button" class="theme-toggle-mobile" aria-label="Toggle theme">
  <svg class="sun-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <circle cx="10" cy="10" r="3" stroke="currentColor" stroke-width="1.5" fill="none"/>
    <path d="M10 2V4M10 16V18M18 10H16M4 10H2M15.657 4.343L14.243 5.757M5.757 14.243L4.343 15.657M15.657 15.657L14.243 14.243M5.757 5.757L4.343 4.343" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
  </svg>
  <svg class="moon-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</button>

<script is:inline>
  (function() {
    // Prevent multiple initializations
    if (window.__themeToggleMobileInitialized) return;

    function initThemeToggleMobile() {
      const toggle = document.querySelector('.theme-toggle-mobile');
      if (!toggle) return;

      // Check if already has listener to prevent duplicates
      if (toggle.dataset.initialized === 'true') return;

      toggle.dataset.initialized = 'true';

      // Get stored theme or default to system preference
      const getTheme = () => {
        const stored = localStorage.getItem('theme');
        if (stored) return stored;
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      };

      // Apply theme to document
      const applyTheme = (theme) => {
        document.documentElement.setAttribute('data-theme', theme);
        // Also toggle class for better CSS specificity
        if (theme === 'dark') {
          document.documentElement.classList.add('dark-theme');
        } else {
          document.documentElement.classList.remove('dark-theme');
        }
        updateToggleState(theme);
      };

      // Update toggle button state
      const updateToggleState = (theme) => {
        toggle.setAttribute('aria-label', `Switch to ${theme === 'light' ? 'dark' : 'light'} mode`);
      };

      // Toggle theme
      const toggleTheme = (e) => {
        e.preventDefault();
        const currentTheme = document.documentElement.getAttribute('data-theme') || getTheme();
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        localStorage.setItem('theme', newTheme);
        applyTheme(newTheme);
      };

      // Initialize
      const initialTheme = getTheme();
      updateToggleState(initialTheme);

      // Event listener
      toggle.addEventListener('click', toggleTheme);
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initThemeToggleMobile);
    } else {
      // DOM is already ready
      initThemeToggleMobile();
    }

    // Reinitialize on View Transitions navigation
    document.addEventListener('astro:page-load', initThemeToggleMobile);

    window.__themeToggleMobileInitialized = true;
  })();
</script>

<style>
  /* Hidden on desktop, only show on mobile */
  .theme-toggle-mobile {
    display: none;
  }

  @media (max-width: 768px) {
    .theme-toggle-mobile {
      display: flex;
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 56px;
      height: 56px;
      background-color: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 50%;
      cursor: pointer;
      transition: all var(--transition-fast);
      padding: 0;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 9999;
    }

    .theme-toggle-mobile:hover {
      background-color: rgba(61, 90, 128, 0.12);
      border-color: var(--color-accent);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .theme-toggle-mobile:focus-visible {
      outline: 2px solid var(--color-accent);
      outline-offset: 2px;
    }

    .sun-icon,
    .moon-icon {
      position: absolute;
      color: var(--color-text-muted);
      transition: all var(--transition-base);
      pointer-events: none;
    }

    .sun-icon {
      opacity: 1;
    }

    .moon-icon {
      opacity: 0;
    }

    :global(:root[data-theme="light"]) .sun-icon {
      opacity: 1;
      transform: rotate(0deg);
      color: var(--color-accent);
    }

    :global(:root[data-theme="light"]) .moon-icon {
      opacity: 0;
      transform: rotate(-30deg) scale(0.8);
    }

    :global(:root[data-theme="dark"]) .sun-icon {
      opacity: 0;
      transform: rotate(30deg) scale(0.8);
    }

    :global(:root[data-theme="dark"]) .moon-icon {
      opacity: 1;
      transform: rotate(0deg);
      color: var(--color-accent);
    }
  }
</style>
